<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Course Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html,body{height:100%;}
        ul { list-style-type: none; padding-left: 1rem; }
        summary{cursor:pointer;}
        .dir { font-weight: bold; }
        #content{height:100%;display:flex;flex-direction:column;}
        #layout{display:flex;flex:1;overflow:hidden;}
        #sidebar{width:250px;overflow-y:auto;height:100%;flex-shrink:0;}
        #main{flex-grow:1;overflow:auto;display:flex;flex-direction:column;}
        #viewer{flex-grow:1;}
        @media (max-width: 768px){
            #sidebar{position:absolute;left:0;top:0;bottom:0;background:#fff;padding:1rem;transform:translateX(-100%);transition:transform .3s;width:250px;z-index:1000;}
            #sidebar.show{transform:translateX(0);}
        }
    </style>
</head>
<body class="container-fluid py-4" style="height:100vh;">
<div id="login">
    <h2 class="mb-3">Login</h2>
    <div class="mb-2"><input class="form-control" id="user" placeholder="username"></div>
    <div class="mb-2"><input class="form-control" id="pass" type="password" placeholder="password"></div>
    <button class="btn btn-primary" onclick="login()">Login</button>
    <div class="text-danger mt-2" id="login-error"></div>
</div>
<div id="content" style="display:none;">
    <button class="btn btn-outline-secondary mb-3 d-md-none" onclick="toggleSidebar()">Файлы</button>
    <div id="layout">
        <div id="sidebar" class="pe-3 border-end">
            <button class="btn btn-sm btn-outline-secondary mb-2 d-md-none" onclick="toggleSidebar()">Закрыть</button>
            <div id="tree"></div>
        </div>
        <div id="main" class="flex-grow-1 ps-3">
            <div id="viewer"></div>
            <br>
            <button class="btn btn-secondary mt-2" onclick="nextFile()">Next</button>
        </div>
    </div>
</div>
<script>
let token = '';
let currentId = null;
function login() {
    fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username:document.getElementById('user').value, password:document.getElementById('pass').value})
    }).then(r=>r.json()).then(d=>{
        if(d.token){
            token = d.token;
            document.getElementById('login').style.display='none';
            document.getElementById('content').style.display='block';
            loadFiles();
        } else {
            document.getElementById('login-error').innerText='Invalid credentials';
        }
    });
}
function loadFiles(){
    fetch('/api/files',{headers:{'Authorization':token}}).then(r=>r.json()).then(d=>{
        document.getElementById('tree').appendChild(renderTree(d));
        fetch('/api/progress',{headers:{'Authorization':token}}).then(r=>r.json()).then(p=>{
            if(p.file_id){ openFileId(p.file_id); }
        });
    });
}
function renderTree(nodes){
    const ul = document.createElement('ul');
    nodes.forEach(n=>{
        const li = document.createElement('li');
        if(n.is_dir){
            const details = document.createElement('details');
            const summary = document.createElement('summary');
            summary.textContent = n.name;
            summary.className = 'dir';
            details.appendChild(summary);
            details.appendChild(renderTree(n.children));
            li.appendChild(details);
        } else {
            li.textContent = n.name;
            idPath[n.id]=n.path;
            li.onclick=()=>openFileId(n.id);
        }
        ul.appendChild(li);
    });
    return ul;
}
function openFileId(id){
    currentId = id;
    const path = idPath[id];
    const viewer = document.getElementById('viewer');
    viewer.innerHTML = '';
    const ext = path.split('.').pop().toLowerCase();
    const url = '/files/' + path.split('/').map(encodeURIComponent).join('/');
    if(['mp4','webm','ogg'].includes(ext)){
        const v = document.createElement('video');
        v.controls = true;
        v.className='w-100 h-100';
        v.style.objectFit='contain';
        v.src = url;
        viewer.appendChild(v);
    } else if(['png','jpg','jpeg','gif','bmp','webp'].includes(ext)){
        const img = document.createElement('img');
        img.className='img-fluid';
        img.src = url;
        viewer.appendChild(img);
    } else if(['html','htm','pdf'].includes(ext)){
        const frame = document.createElement('iframe');
        frame.src = url;
        frame.className='w-100';
        frame.style.minHeight='500px';
        viewer.appendChild(frame);
    } else {
        const a = document.createElement('a');
        a.href = url;
        a.download = path.split('/').pop();
        a.click();
    }
    fetch('/api/progress',{method:'POST',headers:{'Content-Type':'application/json','Authorization':token},body:JSON.stringify({file_id:id})});
}
function nextFile(){
    fetch('/api/progress',{headers:{'Authorization':token}}).then(r=>r.json()).then(p=>{
        const id = p.file_id;
        fetch('/api/next/'+id,{headers:{'Authorization':token}}).then(r=>r.json()).then(n=>{
            if(n.file_id){ openFileId(n.file_id); }
        });
    });
}
const idPath={};
function toggleSidebar(){
    document.getElementById('sidebar').classList.toggle('show');
}
</script>
</body>
</html>
