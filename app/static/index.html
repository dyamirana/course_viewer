<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Course Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        ul { list-style-type: none; padding-left: 1rem; }
        .dir { font-weight: bold; }
    </style>
</head>
<body class="container py-4">
<div id="login">
    <h2 class="mb-3">Login</h2>
    <div class="mb-2"><input class="form-control" id="user" placeholder="username"></div>
    <div class="mb-2"><input class="form-control" id="pass" type="password" placeholder="password"></div>
    <button class="btn btn-primary" onclick="login()">Login</button>
    <div class="text-danger mt-2" id="login-error"></div>
</div>
<div id="content" style="display:none;">
    <h2>Files</h2>
    <div id="tree" class="mb-3"></div>
    <iframe id="viewer" class="w-100" style="height:500px;"></iframe>
    <br>
    <button class="btn btn-secondary mt-2" onclick="nextFile()">Next</button>
</div>
<script>
let token = '';
let currentId = null;
function login() {
    fetch('/api/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username:document.getElementById('user').value, password:document.getElementById('pass').value})
    }).then(r=>r.json()).then(d=>{
        if(d.token){
            token = d.token;
            document.getElementById('login').style.display='none';
            document.getElementById('content').style.display='block';
            loadFiles();
        } else {
            document.getElementById('login-error').innerText='Invalid credentials';
        }
    });
}
function loadFiles(){
    fetch('/api/files',{headers:{'Authorization':token}}).then(r=>r.json()).then(d=>{
        document.getElementById('tree').appendChild(renderTree(d));
        fetch('/api/progress',{headers:{'Authorization':token}}).then(r=>r.json()).then(p=>{
            if(p.file_id){ openFileId(p.file_id); }
        });
    });
}
function renderTree(nodes){
    const ul = document.createElement('ul');
    nodes.forEach(n=>{
        const li = document.createElement('li');
        li.textContent = n.name;
        if(n.is_dir){
            li.className='dir';
            li.appendChild(renderTree(n.children));
        } else {
            idPath[n.id]=n.path;
            li.onclick=()=>openFileId(n.id);
        }
        ul.appendChild(li);
    });
    return ul;
}
function openFileId(id){
    currentId = id;
    const path = idPath[id];
    document.getElementById('viewer').src = '/files/' + path;
    fetch('/api/progress',{method:'POST',headers:{'Content-Type':'application/json','Authorization':token},body:JSON.stringify({file_id:id})});
}
function nextFile(){
    fetch('/api/progress',{headers:{'Authorization':token}}).then(r=>r.json()).then(p=>{
        const id = p.file_id;
        fetch('/api/next/'+id,{headers:{'Authorization':token}}).then(r=>r.json()).then(n=>{
            if(n.file_id){ openFileId(n.file_id); }
        });
    });
}
const idPath={};
</script>
</body>
</html>
